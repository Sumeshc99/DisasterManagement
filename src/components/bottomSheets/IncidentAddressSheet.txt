import React, { forwardRef, useEffect, useState } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  Dimensions,
  Switch,
  ScrollView,
} from 'react-native';
import RBSheet from 'react-native-raw-bottom-sheet';
import { useForm } from 'react-hook-form';
import Geocoder from 'react-native-geocoding';
import { COLOR } from '../../themes/Colors';
import FormTextInput from '../inputs/FormTextInput';
import FormTextInput2 from '../inputs/FormTextInput2';
import LocationManual from '../LocationManual';
import { TEXT } from '../../i18n/locales/Text';
import { FONT, WIDTH } from '../../themes/AppConst';
import ReuseButton from '../UI/ReuseButton';

const { height } = Dimensions.get('window');
import { useSelector } from 'react-redux';
import { RootState } from '../../store/RootReducer';

Geocoder.init('AIzaSyDjFGPFuN3IMaMQU76874r-T1glz8dyupw', { language: 'en' });

interface IncidentAddressSheetProps {
  onSubmit?: (data: any) => void;
}

const IncidentAddressSheet = forwardRef<
  React.ComponentRef<typeof RBSheet>,
  IncidentAddressSheetProps
>(({ onSubmit }, ref) => {
  const [tab, settab] = useState(0);
  const [showLocation, setShowLocation] = useState(false);

  const currlocation = useSelector(
    (state: RootState) => state?.location?.currentLocation,
  );

  const [location, setLocation] = useState<any>({
    address: '',
    latitude: 0,
    longitude: 0,
  });

  useEffect(() => {
    if (currlocation) {
      setLocation({
        address: currlocation?.address || '',
        latitude: Number(currlocation.latitude) || 0,
        longitude: Number(currlocation.longitude) || 0,
      });
    }
  }, [currlocation]);

  const {
    control,
    setValue,
    reset,
    handleSubmit,
    formState: { errors },
  } = useForm({
    defaultValues: {
      country: '',
      flat: '',
      street: '',
      landmark: '',
      city: '',
      division: '',
      state: '',
      pincode: '',
      latitude: '',
      longitude: '',
    },
  });

  useEffect(() => {
    if (location.latitude && location.longitude) {
      (async () => {
        try {
          const url = `https://nominatim.openstreetmap.org/reverse?lat=${location.latitude}&lon=${location.longitude}&format=json&addressdetails=1`;

          const response = await fetch(url, {
            headers: {
              'User-Agent': 'YourAppName/1.0 (your-email@example.com)',
              'Accept-Language': 'en',
              Referer: 'https://yourapp.com/',
            },
          });
          console.log('asas', response);

          const geo = await response.json();
          const addr = geo.address || {};

          setValue('country', addr.country || '');
          setValue('state', addr.state || addr.region || '');
          setValue(
            'city',
            addr.city || addr.town || addr.village || addr.county || '',
          );
          setValue(
            'division',
            addr.suburb || addr.neighbourhood || addr.hamlet || '',
          );
          setValue('pincode', addr.postcode || '');
          setValue(
            'street',
            addr.road || addr.residential || addr.pedestrian || '',
          );
          setValue('flat', location.address || '');
          setValue('latitude', String(location.latitude));
          setValue('longitude', String(location.longitude));
        } catch (err) {
          console.warn('OSM reverse geocode failed:', err);
        }
      })();
    } else {
      reset({
        country: '',
        flat: '',
        street: '',
        landmark: '',
        city: '',
        division: '',
        state: '',
        pincode: '',
        latitude: '',
        longitude: '',
      });
    }
  }, [location, reset, setValue]);

  const handleFormSubmit = (data: any) => {
    const finalData = { ...data, showLocation };
    if (onSubmit) {
      onSubmit(finalData);
    }
    settab(0), (ref as any)?.current?.close?.();
  };

  return (
    <RBSheet
      ref={ref}
      closeOnPressMask
      height={height * 0.85}
      customStyles={{
        container: styles.sheetContainer,
        draggableIcon: { backgroundColor: 'transparent' },
      }}
    >
      <View style={styles.content}>
        <View style={styles.dragIndicator} />

        <View style={styles.headerRow}>
          <View style={styles.sideBox} /> {/* empty left box */}
          <View style={styles.centerBox}>
            <Text style={styles.title}>{TEXT.confirm_address()}</Text>
          </View>
          <TouchableOpacity
            style={styles.sideBox}
            onPress={() => {
              setLocation(''), settab(0), (ref as any)?.current?.close?.();
            }}
          >
            <Text style={styles.closeIcon}>âœ•</Text>
          </TouchableOpacity>
        </View>

        <View style={{ flex: 1, marginTop: 15 }}>
          {tab === 0 ? (
            <>
              <LocationManual
                location={location}
                onChangeLocation={setLocation}
              />
              <ReuseButton
                text={TEXT.look_good()}
                onPress={() => settab(1)}
                style={{ width: WIDTH(50), alignSelf: 'center' }}
              />

              {/* <TouchableOpacity style={styles.button} onPress={() => settab(1)}>
                <Text style={styles.buttonText}>{TEXT.look_good()}</Text>
              </TouchableOpacity> */}
            </>
          ) : (
            <ScrollView showsVerticalScrollIndicator={false}>
              <FormTextInput
                label={TEXT.country_region()}
                name="country"
                control={control}
                editable={false}
                placeholder={TEXT.country_region()}
                rules={{ required: TEXT.country_required() }}
                error={errors.country?.message}
              />

              <FormTextInput
                label={TEXT.detailed_address()}
                name="flat"
                control={control}
                placeholder={TEXT.flat_house()}
                rules={{ required: TEXT.address_required() }}
                error={errors.flat?.message}
              />
              <View style={{ marginTop: -6 }} />
              <FormTextInput2
                label={TEXT.street_address()}
                name="street"
                control={control}
                placeholder={TEXT.street_address()}
                rules={{ required: TEXT.street_required() }}
                error={errors.street?.message}
              />
              <View style={{ marginTop: -6 }} />
              <FormTextInput2
                label={TEXT.nearby_landmark()}
                name="landmark"
                control={control}
                placeholder={TEXT.nearby_landmark()}
                rules={{ required: TEXT.nearby_landmark() }}
                error={errors.landmark?.message}
              />
              <View style={{ marginTop: -6 }} />
              <FormTextInput2
                label="City"
                name="city"
                control={control}
                placeholder={TEXT.city()}
                rules={{ required: TEXT.city_required() }}
                error={errors.city?.message}
              />
              <View style={{ marginTop: -6 }} />
              <FormTextInput2
                label={TEXT.district()}
                name="division"
                control={control}
                placeholder={TEXT.district()}
                rules={{ required: TEXT.district_required() }}
                error={errors.division?.message}
              />
              <View style={{ marginTop: -6 }} />
              <FormTextInput2
                label="State"
                name="state"
                control={control}
                placeholder={TEXT.state()}
                rules={{ required: TEXT.state_required() }}
                error={errors.state?.message}
              />
              <View style={{ marginTop: -6 }} />
              <FormTextInput2
                label="PIN code"
                name="pincode"
                control={control}
                placeholder={TEXT.pincode()}
                keyboardType="numeric"
                rules={{ required: TEXT.pin_code_required() }}
                error={errors.pincode?.message}
              />
              <View style={{ marginTop: -6 }} />
              <View style={styles.coordRow}>
                <View style={{ flex: 1 }}>
                  <FormTextInput2
                    label="Latitude"
                    name="latitude"
                    control={control}
                    error={errors.latitude?.message}
                    rules={{ required:  TEXT.required_latitude()}}
                  />
                </View>
                <View style={{ flex: 1 }}>
                  <FormTextInput2
                    label="Longitude"
                    name="longitude"
                    control={control}
                    error={errors.longitude?.message}
                    rules={{ required: 'Longitude is required' }}
                  />
                </View>
              </View>

              <View style={styles.switchRow}>
                <Text style={styles.switchLabel}>{TEXT.show_location()}</Text>
                <Switch
                  value={showLocation}
                  onValueChange={setShowLocation}
                  thumbColor={showLocation ? COLOR.blue : '#f4f3f4'}
                  trackColor={{ false: '#ddd', true: '#a3c4f3' }}
                />
              </View>

              {/* <TouchableOpacity
                style={styles.button}
                onPress={handleSubmit(handleFormSubmit)}
              >
                <Text style={styles.buttonText}>{TEXT.confirm()}</Text>
              </TouchableOpacity> */}

              <ReuseButton
                text={TEXT.confirm()}
                onPress={handleSubmit(handleFormSubmit)}
                style={{ width: WIDTH(50), alignSelf: 'center' }}
              />
            </ScrollView>
          )}
        </View>
      </View>
    </RBSheet>
  );
});

export default IncidentAddressSheet;

const styles = StyleSheet.create({
  sheetContainer: {
    borderTopLeftRadius: 25,
    borderTopRightRadius: 25,
    backgroundColor: COLOR.white,
  },
  content: {
    flex: 1,
    width: '100%',
    paddingHorizontal: 16,
  },
  dragIndicator: {
    width: 60,
    height: 6,
    borderRadius: 3,
    backgroundColor: '#ddd',
    alignSelf: 'center',
    marginVertical: 12,
  },
  headerRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  title: {
    fontSize: 18,
    fontFamily: FONT.R_BOLD_700,
    color: COLOR.textGrey,
  },
  closeIcon: {
    fontSize: 18,
    fontFamily: FONT.R_BLK_900,
    color: '#444',
  },
  coordRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    gap: 10,
  },
  switchRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  switchLabel: {
    fontSize: 16,
    color: '#333',
    fontWeight: '500',
  },
  button: {
    backgroundColor: COLOR.blue,
    borderRadius: 30,
    paddingVertical: 14,
    alignItems: 'center',
    justifyContent: 'center',
    marginTop: 24,
    shadowColor: '#000',
    shadowOpacity: 0.1,
    shadowOffset: { width: 0, height: 2 },
    shadowRadius: 5,
    elevation: 2,
    marginBottom: 20,
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
  sideBox: {
    width: 40, // same width on both sides ensures center alignment
    justifyContent: 'center',
    alignItems: 'center',
  },

  centerBox: {
    flex: 1, // title takes full center space
    justifyContent: 'center',
    alignItems: 'center',
  },
});
